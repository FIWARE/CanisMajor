<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://canismajor.readthedocs.io/architecture.html">
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>Architecture - CanisMajor</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="https://www.fiware.org/style/fiware_readthedocs.css" rel="stylesheet" />
  <link href="https://www.fiware.org/style/fiware_readthedocs_iot.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Architecture";
    var mkdocs_page_input_path = "architecture.md";
    var mkdocs_page_url = "/architecture.html";
  </script>
  
  <script src="js/jquery-2.1.1.min.js" defer></script>
  <script src="js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="." class="icon icon-home"> CanisMajor</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="index.html">Home</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="architecture.html">Architecture</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#canis-major-in-powered-by-fiware-architecture">Canis Major in powered by FIWARE Architecture</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#flow-diagram">Flow Diagram</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#canis-major-design">Canis Major Design:</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#supported-dlt-clients">Supported DLT Clients</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#storage-type">Storage Type</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#aei-contract-model">AEI Contract Model</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#erc-721">ERC 721</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#aei-architecture">AEI Architecture</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#example">Example</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#supported-methods">Supported Methods</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#dependencies">Dependencies</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#canis-major-with-aei-contract">Canis Major with AEI Contract:</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#use-of-canis-major">Use of Canis Major</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#canis-major-design_1">Canis Major Design</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#usages">Usages</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#creation-of-an-entity-animal-farm-etc">Creation of an Entity (Animal, Farm etc)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#adding-metadata-eventy-on-an-entity-animal-farm-etc">Adding Metadata (eventy) on an Entity (Animal, Farm etc)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#qyery">Qyery</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="apis.html">APIs</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href=".">CanisMajor</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".">Docs</a> &raquo;</li>
    
      
    
    <li>Architecture</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/FIWARE-Blockchain/CanisMajor/docs/edit/master/docs/architecture.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="architecture">Architecture</h1>
<h2 id="canis-major-in-powered-by-fiware-architecture">Canis Major in powered by FIWARE Architecture</h2>
<p>Canis major uses FIWARE Pep-Proxy (fork version) <a href="https://github.com/FIWARE-Blockchain/fiware-pep-proxy">link</a> which allow to config "canismajor endpoint"</p>
<pre><code class="language-sh"> process.env.CANIS_MAJOR_URL = http://localhost:4000 (canis major endpoint)
</code></pre>
<h3 id="flow-diagram">Flow Diagram</h3>
<p><img alt="Architecture Diagram" src="https://raw.githubusercontent.com/FIWARE-Blockchain/CanisMajor/master/docs/images/cm.png" /></p>
<p>The way Canis Major work's in 'Powered By FIWARE' architecture as follows:</p>
<ol>
<li>Request from the user is consist of the Payload, Header with token and DLT_ID (base64 of public key and private key of the blockchain).</li>
<li>Wilma PEP Proxy validate the token and check with the KeyRock IDM and validate the user, permission (Authentication and Autherisation).</li>
<li>Once the user is validate Wilma forward the request to the Context Broker and persist it.</li>
<li>Once the Payload stored in Context Broker Wilma notify to Canis Major with the configuration such as what attribute of the payload should be store, Blockchain Identity of the user.</li>
<li>Futher Canis Major persist the data in blockchain using AEI contract (will be explained futher in this chapter).</li>
</ol>
<h3 id="canis-major-design">Canis Major Design:</h3>
<p>Canis major is designed to submit the transaction in diffrent kind of DLT current it support these blockchain</p>
<h4 id="supported-dlt-clients">Supported DLT Clients</h4>
<ul>
<li>[x] Ethereum </li>
<li>[x] IOTA</li>
<li>[ ] FABRIC Chaincode</li>
</ul>
<p>and is not recommended to use in public-permissionless or crypotcurrencies.</p>
<p>For the Etherum Clients such as geth, quorum, besu etc it is recommended to use AEI contract (plese check the contract section in this documentation), though you can also use your own contract and configure it using canismajor rest api.</p>
<p>Canis Major also support varsion storage type store the payload </p>
<h4 id="storage-type">Storage Type</h4>
<ul>
<li>[x] IPFS </li>
<li>[x] IOTA MaM</li>
<li>[x] Merkle Tree</li>
</ul>
<h5 id="ipfs">IPFS</h5>
<p>You can use IPFS, a distributed system for storing and accessing files and data, in Canis Major Adaptor.
To learn about IPFS please follow <a href="https://ipfs.io/">here</a> </p>
<h5 id="iotamam-masked-authenticated-messaging">IOTAMaM (Masked Authenticated Messaging)</h5>
<p>Canis Major Also Supporta IOTA MaM. The IOTA Tangle allows you to attach zero-value transactions to it, but these transactions are not signed or checked by nodes to verify their authenticity. With MAM, all messages are signed by the owner of a seed.</p>
<p>To learn about IOTA MaM please follow <a href="https://legacy.docs.iota.org/docs/mam/1.0/overview">link</a></p>
<h5 id="merkletree">MerkleTree</h5>
<p>Merkle trees are data structures devised to authenticate, with a unique signature, a set of messages, by at the same time making an intended verifier able to verify authenticity of a single message without the disclosure of the other messages.</p>
<p>To learn about Merkle Tree please follow <a href="https://en.wikipedia.org/wiki/Merkle_tree">link</a></p>
<p>In a canis major merkle is use as mentioned in below</p>
<p><img alt="Sequence Diagram" src="https://raw.githubusercontent.com/FIWARE-Blockchain/CanisMajor/master/docs/images/merkletree.png" /></p>
<h3 id="aei-contract-model">AEI Contract Model</h3>
<p>AEI (Asset, Event and Identity) Smart Contract is written in Solidity using ERC721 standard (NFT) and can be use with Ethereum Clients. It is compatible with FIWARE-Canis Major Adaptor to store the data in blockchain. </p>
<p>ERC 721 Contract is follow OpenZepplin standards, security audits are trusted by leading organizations building decentralized systems.</p>
<h3 id="erc-721">ERC 721</h3>
<p>ERC 721 A standard interface for non-fungible tokens, also known as deeds.
The following standard allows for the implementation of a standard API for NFTs within smart contracts. This standard provides basic functionality to track and transfer NFTs.</p>
<p>We considered use cases of NFTs being owned and transacted by individuals as well as consignment to third party brokers/wallets/auctioneers (“operators”). NFTs can represent ownership over digital or physical assets. We considered a diverse universe of assets, and we know you will dream up many more:</p>
<p>Physical property — houses, unique artwork
Virtual collectables — unique pictures of kittens, collectable cards
“Negative value” assets — loans, burdens and other responsibilities
In general, all houses are distinct and no two kittens are alike. NFTs are distinguishable and you must track the ownership of each one separately.</p>
<p>to know more follow here: </p>
<ol>
<li><a href="https://eips.ethereum.org/EIPS/eip-721">ERC 721</a></li>
<li><a href="https://docs.openzeppelin.com/contracts/2.x/api/token/erc721">OpenZepplin ERC721</a></li>
</ol>
<h4 id="aei-architecture">AEI Architecture</h4>
<p>AEI Contract Design</p>
<p><img alt="Sequence Diagram" src="https://raw.githubusercontent.com/FIWARE-Blockchain/CanisMajor/master/docs/images/aei_model.png" /></p>
<ol>
<li>Entity/Asset with a unique identity will be a new asset (1:1 mapping of asset to an identity).</li>
<li>Event or Metadata of the asset/entity has a 1:n mapping.</li>
<li>An Asset can have a 1:n relationship with any other asset.</li>
</ol>
<h4 id="example">Example</h4>
<p><img alt="Example" src="https://raw.githubusercontent.com/FIWARE-Blockchain/AEIContract/master/docs/images/2.png" /></p>
<h4 id="supported-methods">Supported Methods</h4>
<pre><code class="language-sh">- createAsset(bytes32 uuid, string memory _newHash)
- getAsset(bytes32 uuid)
- updateAsset(bytes32 uuid, string memory _newHash)
- removeAsset (bytes32 uuid)
- isValidAsset(bytes32 uuid, bytes32[] memory _proof, bytes32 _leaf)
- isValidAssetEthMessage(bytes32 uuid, bytes32 _messageHash, bytes memory _signature)
- addRelation(bytes32 uuid, bytes32 reluuid)
- getRelations(bytes32 uuid)
- removeRelation(bytes32 uuid, uint index)
- isValidRelation(bytes32 uuid, uint index, bytes32[] memory _proof, bytes32 _leaf)
- addMetadata(bytes32 uuid, string memory _metadatahash)
- getMetadatas(bytes32 uuid) public view returns (string[] memory)
- removeMetadata(bytes32 uuid, uint index)
- isValidMetadata(bytes32 uuid, uint index, bytes32[] memory _proof, bytes32 _leaf)
</code></pre>
<p>Apart from that ERC721, Ownable, MerkleProof, ECDSA methods are supported.</p>
<h4 id="dependencies">Dependencies</h4>
<p><em>This project uses:</em>
 - truffle
 - NodeJS
 - Ganache-CLI (testrpc)
 - OpenZeppelin</p>
<h4 id="canis-major-with-aei-contract">Canis Major with AEI Contract:</h4>
<p><img alt="Canis Major with AEI Contract" src="https://raw.githubusercontent.com/FIWARE-Blockchain/AEIContract/master/docs/images/3.png" /></p>
<h2 id="use-of-canis-major">Use of Canis Major</h2>
<p>CanisMajor is a blockchain adaptor that supports various DLT.</p>
<h3 id="canis-major-design_1">Canis Major Design</h3>
<p><img alt="CanisMajor Design" src="https://raw.githubusercontent.com/CattleChain/Docs/master/images/cm.png" /></p>
<p>The way Canis Major work's in 'Powered By FIWARE' architecture as follows:</p>
<ol>
<li>Request from the user is consist of the Payload, Header with token and DLT_ID (base64 of public key and private key of the blockchain).</li>
<li>Wilma PEP Proxy validate the token and check with the KeyRock IDM and validate the user, permission (Authentication and Autherisation).</li>
<li>Once the user is validate Wilma forward the request to the Context Broker and persist it.</li>
<li>Once the Payload stored in Context Broker Wilma notify to Canis Major with the configuration such as what attribute of the payload should be store, Blockchain Identity of the user.</li>
<li>Futher Canis Major persist the data in blockchain using AEI contract (will be explained futher in this chapter).</li>
</ol>
<p><a href="https://github.com/FIWARE-Blockchain/CanisMajor">Github Souce</a>
<a href="https://fiware-blockchain.github.io/CanisMajor/architecture.html">Documentation</a></p>
<h2 id="usages">Usages</h2>
<h3 id="creation-of-an-entity-animal-farm-etc">Creation of an Entity (Animal, Farm etc)</h3>
<p><img alt="Creation of an entity" src="https://raw.githubusercontent.com/CattleChain/Docs/master/images/createentity.png" /></p>
<p><strong>Creation of an entity goes as follow:</strong></p>
<ol>
<li>Actor create an request with a payload to PEP Proxy.<ul>
<li>the request is consist of the payload and in header TOKEN (generate from the keyrock IDM) and the DLT_KEYS (which is a base64 for public and private key of the wallet).</li>
</ul>
</li>
<li>Wilma autherize the request of the user by validating it from the keyrock IDM.</li>
<li>On Success wilma submit the request to the Context Broker and the entity will be store.</li>
<li>On Successfully entity creation wilma notify the CanisMajor Adaptor to persist the entity in blockchain (where the smart contract is already configured).<ul>
<li>Willma notify the CanisMajor with payload, dlt_keys in header and it also support option ctx_map (which allow user to mention what particular keys from the payload should be persist in the smart contract).</li>
</ul>
</li>
<li>Canis Major further validate the DLT_KEY (identity), create a signed transaction and submit it to the blockchain.<ul>
<li>Here we are using AEI_Contract and the createAsset method of the contract is called.</li>
</ul>
</li>
<li>On successful transacation creation the tx_reciept of the transaction will be available in canis major, which can be queried any time.</li>
</ol>
<h3 id="adding-metadata-eventy-on-an-entity-animal-farm-etc">Adding Metadata (eventy) on an Entity (Animal, Farm etc)</h3>
<p><img alt="Adding Metadata" src="https://raw.githubusercontent.com/CattleChain/Docs/master/images/addattr.png" /></p>
<p><strong>Adding Metadata on an entity goes as follow:</strong></p>
<ol>
<li>Actor create an request with a payload to PEP Proxy.<ul>
<li>the request is consist of the payload and in header TOKEN (generate from the keyrock IDM) and the DLT_KEYS (which is a base64 for public and private key of the wallet).</li>
</ul>
</li>
<li>Wilma autherize the request of the user by validating it from the keyrock IDM.</li>
<li>On Success wilma submit the request to the Context Broker with the meta information and entity_id.</li>
<li>On Successfully entity creation wilma notify the CanisMajor Adaptor to persist the entity in blockchain (where the smart contract is already configured).<ul>
<li>Willma notify the CanisMajor with payload, dlt_keys in header and it also support option ctx_map (which allow user to mention what particular keys from the payload should be persist in the smart contract).</li>
</ul>
</li>
<li>Canis Major further validate the DLT_KEY (identity), create a signed transaction and submit it to the blockchain.<ul>
<li>here the request is for adding the metadata, canis major will call AddMetadata method of the AEI Contract.</li>
</ul>
</li>
<li>On successful transacation creation the tx_reciept of the transaction will be available in canis major, which can be queried any time.</li>
</ol>
<h3 id="qyery">Qyery</h3>
<p><img alt="Query" src="https://raw.githubusercontent.com/CattleChain/Docs/master/images/query.png" /></p>
<p><strong>Quering the data on blockchain goes as follow:</strong></p>
<ol>
<li>Actor send a request to canis major with the Entity_ID.</li>
<li>Canis major check the transaction details from the local storage and fetch the reciept.</li>
<li>Canis Major futher call the AEI contarct, getAsset method and the fetch the stored hash.</li>
<li>Hash will be returned back to the hash.</li>
</ol>
<p>**Note: the returned Hash could be a IPFS Hash, IOTAMaM hash or MerkleRoot, depend on the configuration of the CanisMajor and data from the has can be fetched or validated from the canismajor query apis (for more checkout the canismajor api specification)"</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="installation.html" class="btn btn-neutral float-right" title="Installation">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/FIWARE-Blockchain/CanisMajor/docs/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="index.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="installation.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme.js" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
